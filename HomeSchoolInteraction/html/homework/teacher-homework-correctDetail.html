<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>批改详情</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.css" rel="stylesheet" />
		<style type="text/css">
			body{
				background: #fff;
			}
			[v-cloak] {
				visibility: hidden;
			}
			
			.selectP {
				margin-right: 10px;
				margin-top: 8px;
				margin-left: 10px;
			}
			
			.homewrokContent {
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
				margin: 5px 10px 5px;
			}
			
			.mui-card-link {}
			
			.carlinkContent {
				font-size: 12px;
				color: darkgray;
				margin-left: 10px;
			}
			
			.title-info {
				padding: 18px 0 5px 0;
				text-align: center;
				background: #fff;
			}
			
			.user-title {
				font-size: 17px;
				color: #333333;
				font-weight: bold;
			}
			
			.user-title-se{
				font-size: 13px;
				color: #6d6d6d;
			}
			
			.user-title-body {
				font-size: 15px;
				text-align: left;
				margin: 0 10px;
				color: #6d6d6d;
				text-indent: 2em;
				word-wrap:break-word
			}
			
			.tow-line{/*文字只显示两行*/
				text-overflow: -o-ellipsis-lastline;
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
			}
			.more-btn{
				color:#6d6d6d;
				float: right;
				margin-top: -24px;
				border: 0;
				padding: 6px 3px;
				font-size: 13px;
				background-color: transparent;
			}
			.right-btn{
				text-align: right;
			}
			.btn-pl{
				border: 1px solid #00CFBD;
				background-color: #00CFBD;
				color: #fff;
				padding: 4px 6px;
				font-size: 12px;
			}
			.line{
				background-color: #f2f3f5;
				height: 10px;
				margin-top: 10px;
			}
			
			.mui-control-content {
				background-color: white;
				min-height: 215px;
			}
			.mui-control-content .mui-loading {
				margin-top: 50px;
			}
			.li-img{
				width: 25px !important;
				height: 25px !important;
				float: left;
			}
			.li-name{
				margin: 2px 0 0 5px;
				float:left;
				color: #333333;
				width: 28%;
			}
			.li-score{
				margin: 2px 0 0 5px;
				float:left;
				color: #333333;
			}
			.li-time{
				margin: 2px 10px 0 0;
				float: right;
				color: #6d6d6d;
				width: 36.333333% !important;
			}
			.li-py{
				margin: 2px 10px 0 0;
				float: right;
				color: #6d6d6d;
				width: 36.333333% !important;
				overflow:hidden;
				text-overflow:ellipsis;
				white-space:nowrap;
				word-break:keep-all;
			}
			
			 .mui-btn:enabled:active, button:enabled:active {
				color: #fff;
				background-color: #fff;
			}  
			
			.mui-grid-view{
				text-align: left;
				/*padding: 0px 0px 10px 0 !important;*/
			}
			.mui-table-view:before {
				height: 0;
			}
			.img-design{
				float: left;
				margin-top: 5px;
				height: 130px;
				object-fit:center;
			}
			
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted ~ .mui-slider-group .mui-slider-item {
				border-bottom: 0;
			}
			
			/*图片预览相关*/
			.mui-preview-image.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			.mui-preview-header,
			.mui-preview-footer {
				position: absolute;
				width: 100%;
				left: 0;
				z-index: 10;
			}
			.mui-preview-header {
				height: 44px;
				top: 0;
			}
			.mui-preview-footer {
				height: 50px;
				bottom: 0px;
			}
			.mui-preview-header .mui-preview-indicator {
				display: block;
				line-height: 25px;
				color: #fff;
				text-align: center;
				margin: 15px auto 4;
				width: 70px;
				background-color: rgba(0, 0, 0, 0.4);
				border-radius: 12px;
				font-size: 16px;
			}
			.mui-preview-image {
				display: none;
				-webkit-animation-duration: 0.5s;
				animation-duration: 0.5s;
				-webkit-animation-fill-mode: both;
				animation-fill-mode: both;
			}
			.mui-preview-image.mui-preview-in {
				-webkit-animation-name: fadeIn;
				animation-name: fadeIn;
			}
			.mui-preview-image.mui-preview-out {
				background: none;
				-webkit-animation-name: fadeOut;
				animation-name: fadeOut;
			}
			.mui-preview-image.mui-preview-out .mui-preview-header,
			.mui-preview-image.mui-preview-out .mui-preview-footer {
				display: none;
			}
			.mui-zoom-scroller {
				position: absolute;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				left: 0;
				right: 0;
				bottom: 0;
				top: 0;
				width: 100%;
				height: 100%;
				margin: 0;
				-webkit-backface-visibility: hidden;
			}
			.mui-zoom {
				-webkit-transform-style: preserve-3d;
				transform-style: preserve-3d;
			}
			.mui-slider .mui-slider-group .mui-slider-item img {
				width: auto;
				height: auto;
				max-width: 100%;
				max-height: 100%;
			}
			.mui-android-4-1 .mui-slider .mui-slider-group .mui-slider-item img {
				width: 100%;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-slider-group .mui-slider-item {
				display: inline-table;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-zoom-scroller img {
				display: table-cell;
				vertical-align: middle;
			}
			.mui-preview-loading {
				position: absolute;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				display: none;
			}
			.mui-preview-loading.mui-active {
				display: block;
			}
			.mui-preview-loading .mui-spinner-white {
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -25px;
				margin-top: -25px;
				height: 50px;
				width: 50px;
			}
			.mui-preview-image img.mui-transitioning {
				-webkit-transition: -webkit-transform 0.5s ease, opacity 0.5s ease;
				transition: transform 0.5s ease, opacity 0.5s ease;
			}
			@-webkit-keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@-webkit-keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background-color:#00CFBD;" id="tempVue">
			<a onclick="mui.back()" class="mui-icon mui-icon-left-nav mui-pull-left" style="color: white;"></a>
			<h1 class="mui-title" style="color: white;">批改详情</h1>
		</header>
		<div class="mui-content" style="background: white;">
			<div id="detail">
				<div class="mui-row title-info">
						<p v-cloak class="user-title">{{homeworkDetail.subname}}作业</p>
						<p v-cloak class="user-title-se">{{homeworkDetail.createUsername}}&nbsp;|&nbsp;{{homeworkDetail.createTime}}</p>
						<p v-cloak class="user-title-body" :class="{'tow-line': more}" @tap="showMore()" >{{homeworkDetail.content}}</p>
						<button v-cloak class="mui-btn more-btn" @tap="showMore()" >{{btnText}}</button><!--:style="{display:more==-1? 'none':'inherit'}"-->
						<ul v-cloak v-show="!more" class="mui-table-view mui-grid-view">
							<li class="mui-table-view-cell mui-media img-design" :class="getWidth(homeworkDetail.files)"  v-for="item in homeworkDetail.files">
								<a href="#"><img class="mui-media-object" :src="item.url" data-preview-src="" data-preview-group="1" ></a>
							</li>
						</ul>
					</div>
					<div class="right-btn">
						<button class="mui-btn btn-pl" @tap="pj()" >批量评价</button>
						<button class="mui-btn btn-pl" @tap="dj()" >批量登记</button>
					</div>
				<div class="line"></div>
			</div>
			<div id="slider" class="mui-slider" style="height: 100%;">
				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
						<a class="mui-control-item" href="#item1mobile">未批</a>
						<a class="mui-control-item" href="#item2mobile">已批</a>
					</div>
				<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6"></div>
				<div class="mui-slider-group">
					<div id="item1mobile" class="mui-slider-item mui-control-content mui-active" style="overflow-y: scroll;">
						<div id="scroll1" >
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<template v-if="wp.length>0">
										<li class="mui-table-view-cell" v-for="(item,index) in wp" @tap="toCritique(index,item)">
											<a class="mui-navigate-right">
												<img class="li-img" :src=item.studentImg  />
												<span class="li-name">{{item.studentName}}</span>
												<template v-if="item.submitStatus==0 || item.submitStatus==1"><!--既不是1未提交也不是0未登记 就显示提交时间  已交2 补交3-->
													<span class="li-time" style="text-align: center;">{{item.submitStatusTxt}}</span>
												</template> 
												<template v-else>
													<span class="li-time">{{item.submitStatusTxt}}({{getSubTime(item.submitTime)}})</span>
												</template>
											</a>
										</li>
									</template>
									<template v-else>
										<p style="margin-left: 15px;">暂无数据</p>
									</template>
								</ul>
							</div>
						</div>
					</div>
					<div id="item2mobile" class="mui-slider-item mui-control-content">
						<div id="scroll2" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<template v-if="yp.length>0">
										<li class="mui-table-view-cell" v-for="(item,index) in yp" @tap="toCritique(index,item)">
											<a class="mui-navigate-right">
												<img class="li-img" :src=item.studentImg />
												<span class="li-name">{{item.studentName}}</span>
												<span class="li-time">{{item.comment}}</span>
											</a>
										</li>
									</template>
									<template v-else>
										<p style="margin-left: 15px;">暂无数据</p>
									</template>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="../../js/slide/mui.min.js"></script>
		<script src="../../js/utils/vue.min.js"></script>
		<script src="../../js/utils/vconsole.min.js"></script>
		<script src="../../js/libs/jquery.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/utils/utils.js"></script>
		<script src="../../js/utils/store.js"></script>
		<script src="../../js/storageKeyName.js"></script>
		<script src="../../js/mui.zoom.js"></script>
		<script src="../../js/mui.previewimage.js"></script>
		<script src="../../js/studentManage/studentManagePermission.js"></script>
		<script src="../../js/publicProtocol-studentManage.js"></script>
		
		<script type="text/javascript">
			var	homeworkDetail = utils.getDataFromUrl(window.location.href);
			var personal = store.get(window.storageKeyName.PERSONALINFO);
			var	publicParameter = store.get(window.storageKeyName.PUBLICPARAMETER);
			mui.init({
				swipeBack: false
			});
			mui.plusReady(function() {
				console.log("resolutionHeight:"+plus.screen.resolutionHeight);
				var heigh=$(window).height()-270;
				$('#item1mobile').height(heigh);
				getHomeworkDetail();
			});
			//初始化图片预览
			mui.previewImage();
			
			//关闭侧滑
			window.addEventListener('refreshHomeworkList', function(data) {
				getHomeworkDetail();
			});
			
			//作业详情
			var detail = new Vue({
				el: "#detail",  
				data: {
					more:true,//该参数如果为true ,讲只显示两行文本,多余的以...省略
					btnText:'>>',//更多按钮
					homeworkDetail:{}//作业对象
				},
				methods: {
					showMore: function(model) {
						if(this.more){//展开
							this.more=false;
							this.btnText='<<';
						}else{//缩放
							this.more=true;
							this.btnText='>>'
						}
					},
					getWidth:function(files){//根据附件数量，返回每张图片占位宽度
						if(files.length>=3){
							return 'mui-col-xs-4';
						}else if(files.length<3){
							return 'mui-col-xs-6';
						} 
					},
					pj:function(){
						console.log('点击了批量评价')
						utils.mOpenWithData("../../html/homework/teacher-homework-evaluate.html", this.homeworkDetail);
					},
					dj:function(){
						console.log('点击了批量登记')
						utils.mOpenWithData("../../html/homework/teacher-homework-submit.html", this.homeworkDetail);
					}
				}
			});
			
			detail.homeworkDetail=homeworkDetail;
			
			window.addEventListener('refresh_correctDetail', function(data) {
				getHomeworkDetail();
			});
			
			//已批未批列表
			var slider =new Vue({
				el:'#slider',
				data:{
					wp:[],//未批作业数组
					yp:[],//已批作业数组
					allList:[],//所有的作业数组，用于作业点评页面 上一个下一个操作选项
					submitArray:[]//上交登记数组
				},
				methods:{
					toCritique:function(index,item){
						console.log("点击第"+index+"个标签，内容为："+JSON.stringify(item))
						utils.mOpenWithData("../../html/homework/teacher-homework-critique.html", [slider.allList,item,slider.submitArray]);
					},
					getSubTime:function(submitTime){
						return submitTime.substring(0,10)
					}
				}
			});
			
			//获取作业已批未批数组
			function getHomeworkDetail(){
				var comData ={
					classId:homeworkDetail.classId,//班级ID
					id:homeworkDetail.id//作业ID
				};
				console.log('comData=='+JSON.stringify(comData));
				var wd = events.showWaiting();
				hwTeacherHomeworketail(comData, function(data) {
					if(data.RspCode == 0) {
						console.log('作业列表:' + JSON.stringify(data));
						getStudentsInfo(wd,data);
					} else {
						mui.toast(data.msg);
					}
				});
			}
			//根据班级ID获取班级下的学生信息
			function getStudentsInfo(wd,ypwpData){
				var enData0 = {};
				//不需要加密的数据
				var comData0 = {
					uuid: publicParameter.uuid, //用户设备号
					utoken: personal.utoken, //用户令牌
					classids: homeworkDetail.classId, //需要查询的班级ID，多个代码用英文逗号隔开
					appid: publicParameter.appid //系统所分配的应用ID
				}
				//2.6 学校班级学生
				postDataEncry('ClassStu', enData0, comData0, 0, function(data) {
					console.log('2.6 学校班级学生:' + JSON.stringify(data));
					wd.close();
					if(data.RspCode == 0) {
						if(data.RspData) {
							var wpList=ypwpData.RspData.unshArray;
							var ypList=ypwpData.RspData.shArray;
							//未批作业数组 拿到学生头像
							for(var i = 0; i < wpList.length; i++) {
								var tempHomework = wpList[i];
								for(var a = 0; a < data.RspData.clssstus.length; a++) {
									var tempStu = data.RspData.clssstus[a];
									if(tempHomework.studentId==tempStu.stuid){
										wpList[i].studentImg=utils.updateHeadImage(tempStu.imgurl,0);
										wpList[i].grdname=tempStu.grdname;
										wpList[i].clsname=tempStu.clsname;
									}
								}
							}
							//已批作业数组 拿到学生头像
							for(var i = 0; i < ypList.length; i++) {
								var tempHomework = ypList[i];
								for(var a = 0; a < data.RspData.clssstus.length; a++) {
									var tempStu = data.RspData.clssstus[a];
									if(tempHomework.studentId==tempStu.stuid){
										ypList[i].studentImg=utils.updateHeadImage(tempStu.imgurl,0);
										ypList[i].grdname=tempStu.grdname;
										ypList[i].clsname=tempStu.clsname;
									}
								}
							}
						} 
						slider.yp=ypList;
						slider.wp=wpList;
						slider.allList = ypList.concat(wpList);
						slider.submitArray=ypwpData.RspData.submitArray;
						console.log('已批作业列表:' + JSON.stringify(slider.yp));
						console.log('未批作业列表:' + JSON.stringify(slider.wp));
					} else {
						mui.toast(data.RspTxt, "cancel");
					}
				});
			}
		</script>
	</body>
</html>
