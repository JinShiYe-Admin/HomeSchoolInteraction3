<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>批改作业</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/utils/pullToRefresh.css" />
		<style type="text/css">
			.selectP {
				margin-right: 10px;
				margin-top: 8px;
				margin-left: 10px;
				text-align: right;
			}
			
			.homewrokContent {
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
				margin: 5px 10px 5px;
			}
			
			.mui-card-link {}
			
			.carlinkContent {
				font-size: 12px;
				color: darkgray;
				margin-left: 10px;
			}
			.selectCell {
				width: 48%;
				margin-left: 2%;
				float: left;
				height: 40px;
				line-height: 40px;
				text-align: center;
				margin-bottom: 5px;
				border-radius: 6px;
			}
			.selectCellBG0{
				background: red;
			}
			.selectCellBG1{
				background: blue;
			}
			
			.bottom-btns {
				width: 100%;
				bottom: 0;
				position: fixed;
				height: 50px;
				background-color: #fff;
				z-index: 999;
				padding: 10px 0;
			}
		</style>
	</head>

	<body>
		<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable">
			<!--菜单部分-->
			<aside id="offCanvasSide" class="mui-off-canvas-right" style="background: white;">
				<div id="offCanvasSideScroll" class="mui-content mui-scroll-wrapper" style="margin-bottom: 50px;">
					<div class="mui-scroll">
						<div id="gradList">
							<ul class="mui-table-view" style="height: 90%;">
								<li class="mui-table-view-cell mui-collapse keep-unfold">
									<a class="mui-navigate-right" href="#">年级</a>
									<div class="mui-collapse-content">
										<div class="selectCell" :class="chlidModel.childFlag==0?'selectCellBG0':'selectCellBG1'" v-for="(chlidModel,index) in grdsList" @tap="modifySelectCell(grdsList,chlidModel,'grd')">
											{{chlidModel.childName}}
										</div>
									</div>
								</li>
								<li class="mui-table-view-cell mui-collapse keep-unfold">
									<a class="mui-navigate-right" href="#">班级</a>
									<div class="mui-collapse-content">
										<div class="selectCell" :class="chlidModel.childFlag==0?'selectCellBG0':'selectCellBG1'" v-for="(chlidModel,index) in classList" @tap="modifySelectCell(classList,chlidModel)">
											{{chlidModel.childName}}
										</div>
									</div>
								</li>
								<li class="mui-table-view-cell mui-collapse keep-unfold">
									<a class="mui-navigate-right" href="#">科目</a>
									<div class="mui-collapse-content">
										<div class="selectCell" :class="chlidModel.childFlag==0?'selectCellBG0':'selectCellBG1'" v-for="(chlidModel,index) in kmList" @tap="modifySelectCell(kmList,chlidModel)">
											{{chlidModel.childName}}
										</div>
									</div>
								</li>
								<li class="mui-table-view-cell mui-collapse keep-unfold">
									<a class="mui-navigate-right" href="#">上交登记</a>
									<div class="mui-collapse-content">
										<div class="selectCell" :class="chlidModel.childFlag==0?'selectCellBG0':'selectCellBG1'" v-for="(chlidModel,index) in sjdjList" @tap="modifySelectCell(sjdjList,chlidModel)">
											{{chlidModel.childName}}
										</div>
									</div>
								</li>
								<li class="mui-table-view-cell mui-collapse keep-unfold">
									<a class="mui-navigate-right" href="#">批改进度</a>
									<div class="mui-collapse-content">
										<div class="selectCell" :class="chlidModel.childFlag==0?'selectCellBG0':'selectCellBG1'" v-for="(chlidModel,index) in pgjdList" @tap="modifySelectCell(pgjdList,chlidModel)">
											{{chlidModel.childName}}
										</div>
									</div>
								</li>
							</ul>
						</div>
					</div>
				</div>
				<div id="dragRightBtn" class="bottom-btns">
					<button type="button" class="mui-btn mui-btn-green mui-btn-outlined" style="margin-bottom: 5px;width: 25%;margin-left: 7%;" @tap='cancel()'>取消</button>
					<button type="button" class="mui-btn mui-btn-green mui-btn-outlined" style="margin-bottom: 5px;width: 25%;margin-left: 7%;" @tap='confirm()'>确定</button>
				</div>
			</aside>
			<div class="mui-inner-wrap" style="margin-top: -8px;">
				<header id="headData" class="mui-bar mui-bar-nav" style="background-color:#00CFBD;">
					<a class="mui-icon mui-icon-left-nav mui-pull-left mui-action-back" style="color: white;"></a>
					<h1 id="title" class="mui-title" style="color: white;">作业列表</h1>
				</header> 
				<div id="rightTag" style="top: 44px;background: white;height: 37px;position: relative;z-index: 3;">
					<p class="selectP" style="padding-top: 7px;">筛选</p>
				</div>
				<div id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper" style="margin-top: 37px;">
				<!--<div id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper" style="margin-top: 8px;">-->
					<div class="mui-scroll main" style="margin-top: -9px;">
						<div id="homeworkListArray" class="" style="background: white;">
							<div class="mui-card" v-for="homeworkModel in homeworkArray" @click="clickHomeworkModel(homeworkModel)">
								<div class="mui-card-header">
									{{homeworkModel.homeworkName}}
									<button v-if="homeworkModel.homeworkFlag ==1" @click.stop="clickBtn(homeworkModel)" type="button" class="mui-btn mui-btn-red mui-btn-outlined">撤销</button>
								</div>
								<div class="mui-card-content">
									<div class="homewrokContent">
										{{homeworkModel.homeworkContent}}
									</div>
									<img :src="homeworkModel.homeworkImg" alt="" width="100%" />
									<a class="mui-card-link carlinkContent" style="margin-left: 10px;">已交/未交:{{homeworkModel.homeworkFlag1}}/{{homeworkModel.homeworkFlag2}}</a>
									<a class="mui-card-link carlinkContent">已批/未批:{{homeworkModel.homeworkFlag3}}/{{homeworkModel.homeworkFlag4}}</a>
									<a class="mui-card-link carlinkContent">平均分:{{homeworkModel.homeworkFlag5}}</a>
		
								</div>
								<div class="mui-card-footer">
									<p class="mui-card-link">发布时间:{{homeworkModel.homeworkFlag6}}</p>
								</div>
							</div>
						</div>
						<!--<div id="backdrop" class="mui-off-canvas-backdrop"></div>-->
					</div>
				</div>
				<div id="backdrop" class="mui-off-canvas-backdrop"></div>
			</div>
		</div>

		<script type="text/javascript" src="../../js/mui.js"></script>
		<script src="../../js/mui/mui.picker.js"></script>
		<script src="../../js/mui/mui.poppicker.js"></script>
		<script src="../../js/utils/vue.min.js"></script>
		<script src='../../js/utils/vconsole.min.js'></script>
		<script src="../../js/utils/store.js"></script>
		<script src="../../js/storageKeyName.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/utils/utils.js"></script>
		<script src="../../js/libs/jquery.js"></script>
		<script src="../../js/libs/RSA/Barrett.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/RSA/BigInt.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/RSA/RSA.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/RSAEncrypt.js" type="text/javascript" charset="utf-8"></script>
		<script src='../../js/libs/crypto-js/require.js'></script>
		<script src='../../js/utils/signHmacSHA1.js'></script>
		<script src='../../js/utils/sortSign.js'></script>
		<script src="../../js/storageKeyName.js"></script>
		<script src="../../js/utils/store.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script src="../../js/studentManage/studentManagePermission.js"></script>
		<script src="../../js/publicProtocol-studentManage.js"></script>
		<script type="text/javascript">
			mui.init()
			
			var personal = store.get(window.storageKeyName.PERSONALINFO);
			console.log('personal:' + JSON.stringify(personal));
			
			var pageIndex = 1; //请求数据页面
			var pageSize = 10; //请求数据页面
			var totalPageCount; //总页码
			var flagRef = 0; //是刷新0，还是加载更多1
			
			//下拉、上滑加载更多
			mui(".mui-scroll-wrapper .mui-scroll.main").pullToRefresh({
				down: {
					callback: function() {
						var self = this;
						if(homeworkListArray.homeworkArray.length>0) {
							pageIndex = 1;
							flagRef = 0;
							getTeacheromeworkList(pageIndex, this)
						} else {
							self.endPullDownToRefresh();
						}
					}
				},
				up: {
					callback: function() {
						var self = this;
						//console.log("上拉加载更多");
						flagRef = 1;
						if(pageIndex <= totalPageCount) {
							getTeacheromeworkList(pageIndex, this)
							//结束下拉刷新
							//self.endPullUpToRefresh();
							if(mui(".mui-table-view-cell").length < 10) {
								mui(".mui-pull-loading")[0].innerHTML = "";
							}
						} else {
							//结束下拉刷新
							self.endPullUpToRefresh();
							mui(".mui-pull-loading")[0].innerHTML = "没有更多了";
						}
					}
				}
			});
			
			//右侧滑出界面数据
			var selectDetailData = new Vue({
				el: "#gradList",
				data: {
					selectFlag: 0,
					grdsList:[],//年级班级数组
					classList:[],//年级班级数组
					kmList:[],//科目数组
					sjdjList:[],//上交登记数组
					pgjdList:[]//批改进度数组
				},
				methods: {
					modifySelectCell: function(sumModel, currentModel,lx) {
						if(lx=='grd'&&currentModel.childFlag==0){//如果选择的类型是年纪&&防止重复点击  更改年级对应班级的值
							var classList=currentModel.children;
							selectDetailData.classList=classList;
						}
						if(currentModel.childFlag == 1){
							currentModel.childFlag = 0;
						}else{
							currentModel.childFlag = 1;
						}
					}
				}
			});
			
			//侧滑菜单按钮初始化
			var dragRightBtn=new Vue({
				el:'#dragRightBtn',
				data:{},
				methods:{
					cancel:function(){//取消按钮点击事件
						offCanvasWrapper.offCanvas('close'); 
					},
					confirm:function(){//确定按钮点击事，相当于下拉刷新
						offCanvasWrapper.offCanvas('close'); 
						pageIndex = 1;
						flagRef = 0;
						getTeacheromeworkList(pageIndex)
						
					}
				}
			});
			
			//作业列表初始化
			var homeworkListArray = new Vue({
				el: "#homeworkListArray",
				data: {   
					homeworkArray: []
				},
				methods: {
					clickHomeworkModel: function(model) {
						console.log('clickHomeworkModel:' + JSON.stringify(model));
					},
					clickBtn: function(model) {
						console.log('clickBtn:' + JSON.stringify(model));
					}
				}
			});
			
			mui.plusReady(function() {
				//TODO 根据老师权限获取年级和班级，科目数组,更改字段
				//获取个人信息中的所有班级
				var tempArray = [].concat(personal.clss);
				//将已经毕业、班主任的班级去掉
				var tempArr = [];
				//处理年级
				for(var i = 0; i < tempArray.length; i++) {
					var tempM = tempArray[i];
					if(tempM.isfinish == 0 && tempM.isms == 0) {
						tempArr.push(tempM);
					}
				}
				tempArr = arrayUnique2(tempArr, 'grdid');
				//班级
				var tempArr1 = [].concat(personal.clss);
				var newList = [];personal
				for(var i = 0; i < tempArr1.length; i++) {
					var temoCls = tempArr1[i];
					if(temoCls.isfinish == 0 && temoCls.isms == 0) {
						newList.push(temoCls);
					}
				}
				newList = arrayUnique2(newList, 'clsid');
				alert(1);
				console.log("年级列表:"+JSON.stringify(tempArr));
				console.log("班级列表:"+JSON.stringify(newList));
				//查询作业列表
//				getTeacheromeworkList(pageIndex)
			});
			
			//数组去重
			function arrayUnique2(arr, name) {
				var hash = {};
				return arr.reduce(function(item, next) {
					hash[next[name]] ? '' : hash[next[name]] = true && item.push(next);
					return item;
				}, []);
			}
			
			//侧滑容器父节点
			var offCanvasWrapper = mui('#offCanvasWrapper');
			var offCanvasSide = document.getElementById("offCanvasSide");
			//侧滑容器的class列表，增加.mui-slide-in即可实现菜单移动、主界面不动的效果；
			var classList = offCanvasWrapper[0].classList;
//			classList.add('mui-slide-in');//加了这个样式，菜单关闭完成事件的监听将不起作用
			offCanvasWrapper.offCanvas().refresh();
			
			
			// 监听点击遮罩关闭事件
			document.getElementById("backdrop").addEventListener('tap', function() {
				//阻止默认事件
				event.detail.gesture.preventDefault();
				offCanvasWrapper.offCanvas('close'); 
				setTimeout(function(){offCanvasWrapper.offCanvas('close');},100);
			});
			
			//菜单显示完成事件
			offCanvasWrapper[0].addEventListener('shown', function(e) { 
			});
			
			//菜单关闭完成事件
			offCanvasWrapper[0].addEventListener('hidden', function(e) { 
				//显示底部tab栏
				mui.fire(plus.webview.currentWebview().opener(), 'showCloseNav', {
					showCloseFlag: 1
				});
			});
			
			//禁止滑动主界面的时候出现侧滑菜单
			document.getElementsByClassName('mui-inner-wrap')[0].addEventListener('drag', function(event) {
				event.stopPropagation();
			});
			
			//筛选按钮点击事件
			document.getElementById('rightTag').addEventListener('tap', function(event) {
				offCanvasWrapper.offCanvas('show');
				mui.fire(plus.webview.currentWebview().opener(), 'showCloseNav', {
					showCloseFlag: 0
				});
			})
			
			//获取作业列表
			function getTeacheromeworkList(index, self){
				var comData =getSelectData();
				console.log('comData=='+JSON.stringify(comData));
				var wd;
				if(flagRef == 0) {
					wd = events.showWaiting();
				}
				hwTeacheromeworkList(comData, function(data) {
					if(flagRef == 0) {
						wd.close();
					}
					console.log('作业列表:' + JSON.stringify(data));
					if(data.RspCode == 0) {
						totalPageCount = data.RspData.totalPage;
						pageIndex++;
						if(data.RspData){
							//解析数据
							//上交登记
							var submitArray=data.RspData.submitArray;
							var submitArrayNew=[];
							for(var i=0;i<submitArray.length;i++){
								var item ={};
								item.childName=submitArray[i].text;
								item.childCode=submitArray[i].value;
								item.childFlag=0;
								submitArrayNew.push(item);
							}
							//批改进度
							var correctArray=data.RspData.correctArray;
							var correctArrayNew=[];
							for(var i=0;i<correctArray.length;i++){
								var item ={};
								item.childName=correctArray[i].text;
								item.childCode=correctArray[i].value;
								item.childFlag=0;
								correctArrayNew.push(item);
							}
							selectDetailData.sjdjList=submitArrayNew;
							selectDetailData.pgjdList=correctArrayNew;
							//作业列表
							var hmList=data.RspData.list;
						}
						//TODO 根据班级ID 年级ID 科目ID得到具体的名称
						for(var i=0;i<hmList.length;i++){
							
						}
						if(flagRef == 0) { //刷新
							if(self) {
								self.endPullDownToRefresh();
							}
							homeworkListArray.homeworkArray=hmList;	
						} else { //加载更多
							if(self) {
								self.endPullUpToRefresh();
							}
							homeworkListArray.homeworkArray=homeworkListArray.homeworkArray.concat(hmList);	
						} 
					} else {
						if(flagRef == 0) { //刷新
							if(self) {
								self.endPullDownToRefresh();
							}
						} else { //加载更多
							if(self) {
								self.endPullUpToRefresh();
							}
						}
						mui.toast(data.msg);
					}
				});
			}
			//得到侧滑菜单选中的值，如果初次进入页面，默认返回的对象的值为空 
			function getSelectData(){
				var comData ={
					gradeId:'',//年级ID
					classId:'',//班级ID
					subCode:'',//科目编码
					submitStatus:'',//上交登记字段
					correctStatus:'',//批改进度字段
					pageNumber:pageIndex,//当前页数
					pageSize:pageSize//每页记录数
				};
				for(var i=0;i<selectDetailData.grdsList.length;i++){
					var item=selectDetailData.grdsList[i];
					if(item.childFlag==1){
						comData.gradeId=item.childCode;
					}
				}
				for(var i=0;i<selectDetailData.classList.length;i++){
					var item=selectDetailData.classList[i];
					if(item.childFlag==1){
						comData.classId=item.childCode;
					}
				}
				for(var i=0;i<selectDetailData.kmList.length;i++){
					var item=selectDetailData.kmList[i];
					if(item.childFlag==1){
						comData.subCode=item.childCode;
					}
				}
				for(var i=0;i<selectDetailData.sjdjList.length;i++){
					var item=selectDetailData.sjdjList[i];
					if(item.childFlag==1){
						comData.submitStatus=item.childCode;
					}
				}
				for(var i=0;i<selectDetailData.pgjdList.length;i++){
					var item=selectDetailData.pgjdList[i];
					if(item.childFlag==1){
						comData.correctStatus=item.childCode;
					}
				}
				return comData;
			}
			//主界面和侧滑菜单界面均支持区域滚动；
			mui('#offCanvasSideScroll').scroll();
			mui('#offCanvasContentScroll').scroll();
		</script>
	</body>

</html>