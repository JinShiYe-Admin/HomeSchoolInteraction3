<!DOCTYPE html>
<html>
	<!--  创建学生账号   -->

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<style type="text/css">
			[v-cloak] {
				display: none;
			}
			
			.mui-content{
				background: #FFF;
			}
			
			.line:before {
				position: absolute;
				top: 0;
				right: 0;
				left: 15px;
				height: 1px;
				content: '';
				-webkit-transform: scaleY(.2);
				transform: scaleY(.2);
				background-color: #c8c7cc;
			}
			
			.head-img{
				width: 50px;
				height:50px;
				border-radius: 100%;
			}
			
			.mui-media-body{
				margin-left: 60px;
			}
			
			.mui-media-body p{
				color: #000;
			}
			
			.mui-ellipsis-title{
				font-size: 14px;
				margin-bottom: 5px;
			}
			
			.row-title{
				background: #F2F2F2;
			}
			
			.mui-content-padded{
				margin-left: 15px;
			}
			
			.mui-content-padded-title{
				font-size: 14px;
				color: #ff9900;
				margin:10px 0 10px 15px;
			}
			
			.mui-table-view-cell{
				font-size: 14px;
			}
			.mui-table-view-cell.mui-active {
			    background-color: #FFF;
			}
			.mui-table-view-cell:after {
			    bottom: 1px;
			}
			
			input[disabled]{
				color:#000;opacity:1;
			}
			
			input::-webkit-input-placeholder {
		         font-size: 14px;
       	    }
       	    
       	    .mui-input-row label {
       	    	padding:11px 0 11px 10px !important;
			    width: 23%;
			    font-size: 14px;
			    line-height: 1.4;
			}
		    .mui-input-row label~input, .mui-input-row label~select, .mui-input-row label~textarea {
			    float: left;
			    width: 53%;
			    font-size: 14px;
			    padding: 10px 0;
			}
			
			.xggl-btn,.jccf-btn{
				background: transparent !important;
				color:#00CFBD !important;
				border: 1px solid #00CFBD !important;
				height: 25px !important; 
				width: 20% !important; 
				font-size: 12px !important;
				padding: 3px 10px !important;
				margin-top: 8px !important;
				right: 2% !important;
			}
		    
		    .zhycz_div{
		    	vertical-align: middle;
		    	float: right;
		    	background: transparent !important;
				color:#FE6D6E !important;
				font-size: 11px !important;
				border: 0 !important;
				height: 25px !important; 
				width: 23% !important; 
				padding: 5px 5px !important;
				margin-top: 6px !important;
				right: 2% !important;
		    }
		    
		    .bcz-img {
		    	vertical-align: middle;
			    width: 12px;
			    height: 12px;
			}
		    .mui-icon-clear{
		    	display: none;
		    }
		    
		 
		    
		    /*div row line*/ 
			/*ul line*/	
			
		     /*input radio*/
		    
		    .check-img{
		    	vertical-align: middle;
		    	width: 25px;
		    	height: 25px;
		    	margin-left: 15px;
		    }
			
			.mui-button-row{
				text-align: right;
				padding-right: 2%;
			}
			.mui-btn-dgr{
				background: #00CFBD !important;
				color:#fff !important;
				border: 1px solid #00CFBD !important;
				height: 25px !important; 
				width: 20% !important; 
				font-size: 12px !important;
				padding: 3px 10px !important;
				margin-top: 8px !important;
				right: 2% !important;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background-color:#00CFBD;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color:#ffffff"></a>
			<h1 class="mui-title" style="color: white;">创建学生账号</h1>
		</header>
		<div id='scroll' class="mui-content">
			<div id="info">
				<div class="mui-row">
					<h5 class="mui-content-padded">家长信息</h5>
					<div class="mui-input-row line">
						<div style="margin: 10px 0 0 15px;">
							<img class="mui-media-object mui-pull-left head-img" :src=personal.imgurl>
							<div class="mui-media-body">
								<p class='mui-ellipsis-title'>{{personal.utname}}</p>
								<p class='mui-ellipsis'>{{personal.uid}}</p>
							</div>
						</div>
					</div>
				</div>
				<div class="mui-row row-title" style="height: 34px;">
					<h5 class="mui-content-padded-title">套餐关联的学生信息</h5>
				</div>
				<div class="mui-row">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell mui-collapse keep-unfold" v-for="(students,stuIndex) in stuList">
							<template v-if="students.createFormShow">
								<a class="mui-navigate-right" href="#"><span style="color: #00CFBD;">【空】</span> {{students.stuname}}</a>
								<div style="margin-left: 10px;">
									<div class="mui-collapse-content">
										<form class="mui-input-group">
											<div class="mui-input-row">
												<label>学生账号:</label>
												<input type="text" name="account" class="mui-input-clear" placeholder="（6-18位字母组合）" :disabled="students.disabled" :value="students.lgname" v-on:input='inputFunc($event,stuIndex)'/>
												<!--<button  v-show='students.checkBtn' @click="checkeAccount($event,index)" type="button" class="mui-btn mui-btn-block mui-btn-primary jccf-btn">检查</button>-->
												<div  v-show='students.accountIsExists'  class="zhycz_div"><img src="../../img/homeSchool/warning.png" class="bcz-img"/>账号已存在</div>
											</div> 
											<div class="mui-input-row">
												<label>密码:</label>
												<input type="password" name="password" class="mui-input-clear" placeholder="（6-18位字母组合）">
											</div>
											<div class="mui-input-row">
												<label>确认密码:</label>
												<input type="password" name="repassword" class="mui-input-clear" placeholder="确认密码">
											</div>
											<div class="mui-button-row" > 
												<template v-if="students.lgname==null||students.lgname==''">
													<button class="mui-btn mui-btn-dgr" type="button" @click="submitStuAccount($event,stuIndex)">确认</button>
												</template>
												<template v-else>
													<button class="mui-btn mui-btn-dgr" type="button" @click="submitStuAccount($event,stuIndex)">确认</button>
													<button class="mui-btn mui-btn-primary jccf-btn" type="button"  @click="cancel($event,stuIndex)">取消</button>
												</template>
											</div>
										</form>
									</div>
								</div>
							</template>
							<template v-else>
								<a class="mui-navigate-right" href="#">{{students.stuname}}</a>
								<div style="margin-left: 10px;">
									<div class="mui-collapse-content">
										<form class="mui-input-group">
											<div class="mui-input-row">
												<label>账号:</label>
												<input type="text" :value="students.lgname" disabled>
											</div>
											<div class="mui-input-row">
												<label>密码:</label>
												<input type="password" :value="students.upw" disabled>
											</div>
											<div class="mui-button-row">
												<button class="mui-btn mui-btn-dgr" type="button" @click="modifyStu($event,stuIndex)">修改</button>
											</div>
										</form>
									</div>
								</div>
							</template>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../../js/mui-ul-keep-fold.js"></script>
		<script type="text/javascript" src="../../js/utils/vue.js"></script>
		<!--加密-->
		<script src="../../js/libs/RSA/Barrett.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/RSA/BigInt.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/RSA/RSA.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/RSAEncrypt.js" type="text/javascript" charset="utf-8"></script>
		<!---->
		<script type="text/javascript" src="../../js/utils/vconsole.min.js"></script>
		<script src='../../js/libs/crypto-js/require.js'></script>
		<script src='../../js/utils/signHmacSHA1.js'></script>
		<script src='../../js/libs/jquery.js'></script>
		<script src="../../js/publicProtocolNew.js"></script>
		<script src='../../js/utils/sortSign.js'></script>
		<script src="../../js/storageKeyName.js"></script>
		<script src="../../js/utils/store.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/utils.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/storageutil.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/events.js"></script>
		<script>
			
			mui.init({
				pullRefresh: {
					container: '#scroll',
					down: {
						style: 'circle', //必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
						color: '#2BD009', //可选，默认“#2BD009” 下拉刷新控件颜色
						height: '50px', //可选,默认50px.下拉刷新控件的高度,
						range: '100px', //可选 默认100px,控件可下拉拖拽的范围
						offset: '0px', //可选 默认0px,下拉刷新控件的起始位置
						auto: false, //可选,默认false.首次加载自动上拉刷新一次
						callback: pulldownRefresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					}
				}
			});
			
			//下拉刷新
			function pulldownRefresh() {
				location.reload();
			}			
			
			var personal;
			var publicParameter;
			var info ;
			mui.plusReady(function() {
				//获取个人信息
				personal = store.get(window.storageKeyName.PERSONALINFO);
				console.log('personal:' + JSON.stringify(personal));
				publicParameter = store.get(window.storageKeyName.PUBLICPARAMETER);
				personal.imgurl = setImg(personal.imgurl);
				info =new Vue({ 
					el:'#info',
					data:{
						personal:personal,
						isDisabled:true,
						stuList:[]
					},
					methods:{
						inputFunc:function(ev,stuIndex){//input输入框事件
							var value=$(ev.target).val();
							if(value==''){
								var obj=this.stuList[stuIndex];
									obj.accountIsExists=false;//账号重复是否显示
									this.$set(this.stuList, stuIndex, obj);
							}else{
								var regex=/^[\u4e00-\u9fa50-9A-Za-z]+$/;
								var myReg = /^[a-zA-Z0-9_]{0,}$/;
								var reg = /[\u4e00-\u9fa5]/g; 
								var result=regex.test(value);
								var result2=myReg.test(value);
								var endStr='';
								if(result==true&&result2==true){
								 	endStr=value;
								}else{//包含中文或特殊字符
								  	var newStr=value.substring(0,value.length-1);
								  	if(result2==false){//去掉中文
								  	 	endStr=newStr.replace(reg,"")
								  	}else{
								  		endStr=newStr
								  	}
								}
								var obj=this.stuList[stuIndex];
								obj.lgname=endStr;
								this.$set(this.stuList, stuIndex, obj);
							}
						},
						modifyStu:function(ev,stuIndex){//修改关联
							var btnArray = ['取消', '确认'];
							var parent=this;
							mui.confirm('您确定要修改学生信息吗？', '校讯通', btnArray, function(e) {
								if (e.index == 1) {
									var stuObj=parent.stuList[stuIndex];
									stuObj.createFormShow=true;
									parent.$set(parent.stuList, stuIndex, stuObj);
								}
							})
						},
						submitStuAccount:function(ev,stuIndex){//点击确定提交学生信息
							var formobj=$(ev.target).parent().parent().serializeObject();
							var parent=this;
							if(formobj.account==undefined){//修改学生密码
								if(formobj.password==''){
									mui.toast('密码不能为空');
								}else if(formobj.repassword==''){
									mui.toast('请再次输入密码');
								}else if(formobj.password.length > 18 || formobj.password.length < 6){//密码长度验证
									mui.toast('密码长度需为6到18个字符');
								}else if(!checkPass(formobj.password)){//密码正则验证
									mui.toast('只能输入数字和字母');
								}else if(!(formobj.password==formobj.repassword)){//两次密码验证
									mui.toast('两次输入的密码不一致');
								}else{
									var stuObj=this.stuList[stuIndex];
									UpStuInfo(stuObj.stuid,formobj.password,'upw',function(){
										mui.toast('密码修改成功');
										stuObj.upw=formobj.password;
										parent.$set(parent.stuList, stuIndex, stuObj);
										parent.$options.methods.cancel(ev,stuIndex);
										console.log(JSON.stringify(parent.stuList))
									},function(){
										mui.toast('密码修改失败');
									})
								}
							}else{//创建学生账号
								if(formobj.account==''){
									mui.toast('账号不能为空');
								}else if(formobj.password==''){
									mui.toast('密码不能为空');
								}else if(formobj.repassword==''){
									mui.toast('请再次输入密码');
								}else if(formobj.account.length > 18 || formobj.account.length < 6){//账号长度验证
									mui.toast('账号长度需为6到18个字符');
								}else if(!checkPass(formobj.account)){//账号正则验证
									mui.toast('账号需为数字和字母的组合');
								}else if(formobj.password.length > 18 || formobj.password.length < 6){//密码长度验证
									mui.toast('密码长度需为6到18个字符');
								}else if(!checkPass(formobj.password)){//密码正则验证
									mui.toast('密码长度需为6到18个字符');
								}else if(!(formobj.password==formobj.repassword)){//两次密码验证
									mui.toast('两次输入的密码不一致');
								}else{
									//TODO 验证账号是否存在
									var stuObj=this.stuList[stuIndex];
									UpStuInfo(stuObj.stuid,formobj.account,'uname',function(){
										UpStuInfo(stuObj.stuid,formobj.password,'upw',function(){
											mui.toast('账号创建成功');
											stuObj.lgname=formobj.account;
											stuObj.upw=formobj.password;
											parent.$set(parent.stuList, stuIndex, stuObj);
											parent.$options.methods.cancel(ev,stuIndex);
											console.log(JSON.stringify(parent.stuList))
											stuObj.accountIsExists=false;
										},function(){
											mui.toast('账号创建失败')
											stuObj.accountIsExists=true;
										});
									},function(){
										stuObj.accountIsExists=true;
										parent.$set(parent.stuList, stuIndex, stuObj);
									})
								}
							}
						},
						cancel:function(ev,stuIndex){//点击取消按钮
							$(ev.target).parent().parent().find('input').each(function(){
								$(this).val('')
							});
							if(info.stuList[stuIndex].lgname==''){}else{
								var obj=info.stuList[stuIndex];
								obj.createFormShow=false;
								Vue.set(info.stuList, stuIndex, obj);
							}
						}
					},
					mounted:function(){
						getUserMstu();
					}
				});
			});
			
			
			
			function UpStuInfo(stuid,param,type,success,fail){
				var enData1 = {};
				//不需要加密的数据
				var comData1 = {
					uuid: publicParameter.uuid, //用户设备号
					stuid:stuid,
					type:type,
					val:param,
					utoken: personal.utoken, //用户令牌
					appid: publicParameter.appid //系统所分配的应用ID
				};
				events.showWaiting();
				//获取验证码
				//发送网络请求，data为网络返回值
				postDataEncry('UpStuInfo', enData1, comData1, 0, function(data1) {
					console.log('UpStuInfo:' + JSON.stringify(data1));
					events.closeWaiting();
					if(data1.RspCode == 0) {
						if(data1.RspData==null){
							console.log('返回数据为空')
							success();
						}else{
							fail();
						}
					} else {
						fail();
						mui.toast(data1.RspTxt);
					}
				});		
			}
			
			//4.5:	获取用户关联的学生列表
			function getUserMstu() {
				var enData1 = {};
				//不需要加密的数据
				var comData1 = {
					uuid: publicParameter.uuid, //用户设备号
					utid: personal.utid, //用户账号
					utoken: personal.utoken, //用户令牌
					appid: publicParameter.appid //系统所分配的应用ID
				};
				events.showWaiting();
				//获取验证码
				//发送网络请求，data为网络返回值
				postDataEncry('UserUstu', enData1, comData1, 0, function(data1) {
					console.log('UserUstu:' + JSON.stringify(data1));
					events.closeWaiting();
					if(data1.RspCode == 0) {
						if(data1.RspData==null){
							console.log('返回数据为空')
						}else{
							var _stuList =[].concat(data1.RspData.stus)
							var stuList=[];
							var stuIdList=[];
							for(var i =0;i<_stuList.length;i++){
								var stu=_stuList[i];
								var stuid=_stuList[i].stuid;
							　　if($.inArray(stuid,stuIdList)==-1) {
							　　		stuIdList.push(stuid);
									stu['accountIsExists']=false;//账号已存在提示是否显示
									stu['upw']=123456;
									if(stu.lgname==''||stu.lgname==null){
										stu['createFormShow']=true;//创建学生账号表单是否显示
										stu['disabled']=false;//学生账号input是否可编辑
									}else{
										stu['createFormShow']=false;
										stu['disabled']=true;
									}
								    stuList.push(stu);
							　　}
							}
							info.stuList=stuList;
							console.log("stuList:"+JSON.stringify(info.stuList))
						}
					} else {
						mui.toast(data1.RspTxt);
					}
				});
			}
			
			//将输入表单中的内容，转为obj
			$.fn.serializeObject = function() {
				var o = {};
				var a = this.serializeArray();
				$.each(a, function() {
					if(o[this.name] !== undefined) {
						if(!o[this.name].push) {
							o[this.name] = [o[this.name]];
						}
						o[this.name].push(this.value || '');
					} else {
						o[this.name] = this.value || '';
					}
				});
				return o;
			};
			
			//判断字符串是否为数字和字母组合
			function checkPass(password) {
				var re = /^(?!([a-zA-Z]+|\d+)$)[a-zA-Z\d]{6,20}$/g;
				if(!re.test(password)) {
					return false;
				} else {
					return true;
				}
			}
		</script>
	</body>

</html>